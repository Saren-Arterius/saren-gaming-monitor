<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>System Monitor</title>
  <link rel="stylesheet" href="https://unpkg.com/mvp.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    #root {
      width: 100%;
    }

    body {
      background-color: rgb(2, 2, 5);
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      color: white;
    }

    .container {

      padding-left: 20px;
      padding-right: 20px;
    }

    .section {
      min-height: 200px;
    }

    .section-title {
      font-weight: 500;
      font-size: 1.2em;
      margin-top: 10px;
      margin-bottom: 10px;
      color: #fff;
      opacity: 0.9;
    }

    .gauge-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .gauge {
      width: 150px;
      height: 150px;
    }

    .gauge-body {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: relative;
    }

    .gauge-fill {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      transform: rotate(-135deg);
      background: conic-gradient(#70CAD1 0%, #F7EE7F 37.5%, #A63D40 75%, transparent 0%);
      filter: brightness(1.25);
      z-index: -2;
    }

    .gauge-cover {
      width: 75%;
      height: 75%;
      background: rgb(2, 2, 5);
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: -2;
    }


    .gauge-cover-2 {
      width: 102%;
      height: 102%;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-135deg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: conic-gradient(transparent 0deg, transparent var(--a), rgb(2, 2, 5) calc(var(--a) + 0.2%));
      z-index: -2;
      transition: --a 1s ease-out;
    }


    .gauge-cover-outer {
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .container::before {
      content: '';
      position: absolute;
      backdrop-filter: blur(50px) brightness(4) saturate(2);
      opacity: 0.25;
      z-index: -1;
      inset: 0px;
      height: 100vh;
    }

    .gauge-value {
      color: white;
      font-size: 2em;
      font-weight: 600;
      margin-top: 100px;
      white-space: nowrap;
    }

    .gauge-label {
      margin-top: -5px;
      color: white;
      font-size: 0.8em;
      opacity: 0.5;
      white-space: nowrap;
    }

    .chart {
      width: 100%;
      height: 100px;
      background: #2a2a2a;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .fan-speed {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      background: #2a2a2a;
      padding: 10px;
      border-radius: 5px;
    }

    .feather {
      width: 36px;
      height: 36px;
    }

    .feather-wrapper {
      z-index: -2;
      position: absolute;
      top: 52px;
      filter: contrast(2) brightness(1.5);
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/mobx@6.12.0/dist/mobx.umd.production.min.js"></script>
  <script src="https://unpkg.com/mobx-react-lite@3.4.3/dist/mobxreactlite.umd.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.2/feather.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.min.js"></script>


  <script type="text/babel">
    const { useEffect } = React;

    const { makeAutoObservable } = mobx;
    const { Observer, observer } = mobxReactLite;
    // const { Circle, Cpu, Activity } = require('react-feather');

    class Store {
      temperatures = {
        cpu: 30,
        gpu: 50,
        ssd: 14
      };
      usage = {
        cpu: 34,
        gpu: 50,
        ram: 35,
        vram: 35,
      };
      usageMB = {
        ram: 16384,
        vram: 10240,
      };
      io = {
        diskRead: 10000,
        diskWrite: 10000,
        networkRx: 1000054300,
        networkTx: 1000054300,
      };
      fanSpeed = {
        cpu: 1500,
        motherboard: 2100
      };
      frequencies = {
        cpu: [0],
        gpuCore: 0,
      };
      pwr = {
        gpu: 0,
      };

      lastUpdate = 1732315685023;

      constructor() {
        makeAutoObservable(this);
      }
    }


    const store = new Store();

    function getColorAtPercent(percent) {
      // Define color stops
      const colorStops = [
        { color: '#70CAD1', position: 0 },
        { color: '#F7EE7F', position: 50 },
        { color: '#A63D40', position: 100 }
      ];

      // Find the two colors to interpolate between
      let start = colorStops[0];
      let end = colorStops[1];

      for (let i = 1; i < colorStops.length; i++) {
        if (percent <= colorStops[i].position) {
          start = colorStops[i - 1];
          end = colorStops[i];
          break;
        }
      }

      // Calculate the percentage between the two colors
      const range = end.position - start.position;
      const adjustedPercent = (percent - start.position) / range;

      // Convert hex to RGB
      const startRGB = hexToRGB(start.color);
      const endRGB = hexToRGB(end.color);

      // Interpolate between the colors
      const r = Math.round(startRGB.r + (endRGB.r - startRGB.r) * adjustedPercent);
      const g = Math.round(startRGB.g + (endRGB.g - startRGB.g) * adjustedPercent);
      const b = Math.round(startRGB.b + (endRGB.b - startRGB.b) * adjustedPercent);

      // Convert back to hex
      return rgbToHex(r, g, b);
    }

    // Helper function to convert hex to RGB
    function hexToRGB(hex) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return { r, g, b };
    }

    // Helper function to convert RGB to hex
    function rgbToHex(r, g, b) {
      return '#' + [r, g, b].map(x => {
        const hex = x.toString(16);
        return hex.length === 1 ? '0' + hex : hex;
      }).join('');
    }

    function formatBytes(bytes, decimals = 1) {
      if (bytes === 0) return '0 B';

      if (bytes >= 1024 * 1024) {
        // Convert to MB
        let mb = bytes / (1024 * 1024);
        if (mb >= 1000) {
          return `${(bytes / (1024 * 1024)).toFixed(0)} MB`;
        }
        return `${(bytes / (1024 * 1024)).toFixed(decimals)} MB`;
      } else if (bytes >= 1024) {
        // Convert to KB
        return `${(bytes / 1024).toFixed(decimals)} KB`;
      } else {
        // Leave as Bytes
        return `${bytes} B`;
      }
    }

    function getGMT8Time(t) {
      const now = new Date(t);
      // Add GMT+8 offset
      now.setHours(now.getHours());

      // Format components
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');

      // Combine in desired format
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }



    const Gauge = ({ value, valueMB, max, label, className, featherName, small, cpuFreq, gpuFreq, gpuPwr }) => {
      useEffect(() => {
        // Runs only on mount (empty dependency array)
        feather.replace();
      }, []);

      let pct = (value / max) * 75;
      if (pct > 75) pct = 75;
      let iconColor = getColorAtPercent(pct / 0.75);
      let valueExtra = {
        'usage': '%',
        'usage': '%',
        'temperature': 'Â°C',
      }[className] || '';
      if (className === 'io') {
        value = formatBytes(value) + '/s';
      }
      let size = small ? 120 : undefined;
      return (
        <div class="gauge" style={{ width: size, height: size, }}>
          <div class="gauge-body">
            <div>
              <div class="gauge-fill"></div>
              <div class="gauge-cover"></div>
              <div class="gauge-cover-2" style={{ "--a": `${pct}%` }}></div>
              <div class="gauge-cover-outer">
                <div class="feather-wrapper" style={{ "color": `${iconColor}`, top: small ? 40 : undefined }}>
                  <i data-feather={featherName} ></i>
                </div>
                <div class="gauge-value" style={{ transform: className === 'io' ? 'scale(0.8)' : undefined }}>{value}{valueExtra}</div>
                <div class="gauge-label">{label}{valueMB ? ` / ${valueMB} MB` : ''}
                  {cpuFreq ? ` / ${Math.round(Math.min(...store.frequencies.cpu))}-${Math.round(Math.max(...store.frequencies.cpu))} MHz` : ''}
                  {gpuFreq ? ` / ${store.frequencies.gpuCore} MHz` : ''}
                  {gpuPwr ? ` / ${store.pwr.gpu} W` : ''}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const Monitor = observer(() => {
      return (
        <div className="container">
          <div style={{ paddingTop: 10 }}></div>
          <div className="section">
            <div className="section-title">Temperature</div>
            <div className="gauge-container">
              <Gauge value={store.temperatures.cpu} max={95} label="CPU" className="temperature" featherName="cpu" />
              <Gauge value={store.temperatures.gpu} max={80} label="GPU" className="temperature" featherName="image" gpuPwr />
              <Gauge value={store.temperatures.ssd} max={70} label="SSD" className="temperature" featherName="hard-drive" />
            </div>
          </div>
          <div className="section">
            <div className="section-title">Usage</div>
            <div className="gauge-container">
              <Gauge value={store.usage.cpu} max={100} label="CPU" className="usage" featherName="cpu" small cpuFreq />
              <Gauge value={store.usage.gpu} max={100} label="GPU" className="usage" featherName="image" small gpuFreq />
              <Gauge value={store.usage.ram} valueMB={store.usageMB.ram} max={100} label="RAM" className="usage" featherName="server" small />
              <Gauge value={store.usage.vram} valueMB={store.usageMB.vram} max={100} label="VRAM" className="usage" featherName="monitor" small />
            </div>
          </div>
          <div className="section" >
            <div className="section-title">I/O</div>
            <div className="gauge-container">
              <Gauge value={store.io.diskRead} max={3.75 * 1024 * 1024 * 1024} label="Disk Read" className="io" featherName="hard-drive" small />
              <Gauge value={store.io.diskWrite} max={3.75 * 1024 * 1024 * 1024} label="Disk Write" className="io" featherName="activity" small />
              <Gauge value={store.io.networkRx} max={1.25 * 1024 * 1024 * 1024} label="Network RX" className="io" featherName="globe" small />
              <Gauge value={store.io.networkTx} max={1.25 * 1024 * 1024 * 1024} label="Network TX" className="io" featherName="globe" small />
            </div>
          </div>
          <div style={{ display: 'flex' }} >
            <div className="section" style={{ flexGrow: 1 }}  >
              <div className="section-title">Fan Speed</div>
              <div className="gauge-container">
                <Gauge value={store.fanSpeed.cpu} max={2200} label="CPU" className="fan" featherName="cpu" />
                <Gauge value={store.fanSpeed.motherboard} max={12000} label="Motherboard" className="fan" featherName="server" />

              </div>

            </div>
            <div className="section" style={{ width: 220 }} >
              <div className="section-title">Info</div>
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'end',
                justifyContent: 'center',
                width: '100%',
                fontSize: '100%',
                zIndex: -2
              }}>
                <div style={{ fontSize: '1.5em', fontWeight: 600, zIndex: -2, color: '#70CAD1' }}>saren-gaming-pc</div>
                <div style={{ opacity: 0.5 }}>AMD Ryzen 7 9800X3D</div>
                <div style={{ opacity: 0.5 }}>NVIDIA GeForce RTX 4090</div>
                <div style={{ opacity: 0.5 }}>Lian Li A4-H2O</div>
                <div style={{ opacity: 0.5 }}>Arch Linux</div>
                <div style={{ fontWeight: 600 }}>{getGMT8Time(store.lastUpdate)}</div>
              </div>
            </div>
          </div>

        </div>
      )
    });

    ReactDOM.createRoot(document.getElementById("root")).render(
      <React.StrictMode>
        <Observer>{() => <Monitor />}</Observer>
      </React.StrictMode>
    );

    const socket = io();

    // Listen for connection
    socket.on('connect', () => {
      console.log('Connected to server');
    });

    socket.on('metrics', (data) => {
      try {
        // Parse the incoming data if it's a string
        const systemData = typeof data === 'string' ? JSON.parse(data) : data;

        store.temperatures = systemData.temperatures;
        store.usage = systemData.usage;
        store.usageMB = systemData.usageMB;
        store.io = systemData.io;
        store.fanSpeed = systemData.fanSpeed;
        store.lastUpdate = systemData.lastUpdate;
        store.frequencies = systemData.frequencies;
        store.pwr = systemData.pwr;

      } catch (error) {
        console.error('Error processing system info:', error);
      }
    });


  </script>
  <style>
    @property --a {
      syntax: '<percentage>';
      inherits: false;
      initial-value: 0%;
    }
  </style>
</body>

</html>